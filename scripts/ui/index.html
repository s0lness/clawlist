<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Clawlist</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="top">
      <div class="brand">Clawlist</div>
      <div class="actions">
        <button id="resetBtn" class="reset">Reset Logs + Rerun</button>
        <div class="hint">Full wipe: run <code>npm run reset-all</code></div>
        <div class="status" id="status">Connecting...</div>
      </div>
    </header>
    <section class="roles" id="roles"></section>

    <main class="grid">
      <section class="panel">
        <h2>Listings</h2>
        <div id="listings" class="listings"></div>
        <div class="subhead">Deals</div>
        <div id="deals" class="deals"></div>
      </section>
      <section class="panel">
        <h2>Gossip Board</h2>
        <div id="gossipSelected" class="selected"></div>
        <div id="gossip" class="board"></div>
      </section>
      <section class="panel">
        <h2>DM</h2>
        <div id="dm" class="chat"></div>
      </section>
    </main>

    <script>
      const statusEl = document.getElementById("status");
      const gossipEl = document.getElementById("gossip");
      const dmEl = document.getElementById("dm");
      const rolesEl = document.getElementById("roles");
      const listingsEl = document.getElementById("listings");
      const dealsEl = document.getElementById("deals");

      function parseLog(text) {
        const lines = text.split("\n").filter(Boolean);
        return lines.map((line, idx) => {
          const first = line.indexOf(" ");
          const second = line.indexOf(" ", first + 1);
          const third = line.indexOf(" ", second + 1);
          if (first === -1 || second === -1 || third === -1) {
            return { ts: "", tsMs: 0, sender: "unknown", body: line, idx };
          }
          const ts = line.slice(0, first);
          const tsMs = Date.parse(ts) || 0;
          return {
            ts,
            tsMs,
            sender: line.slice(first + 1, second),
            body: line.slice(third + 1),
            idx,
          };
        });
      }

      function senderClass(sender) {
        if (sender.includes("agent_a")) return "from-a";
        if (sender.includes("agent_b")) return "from-b";
        return "from-other";
      }

      function renderChat(el, messages) {
        const wasAtBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 24;
        el.innerHTML = "";
        for (const msg of messages) {
          const row = document.createElement("div");
          row.className = `msg ${senderClass(msg.sender)}`;

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${msg.sender} 路 ${msg.ts}`;

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.textContent = msg.body;

          row.appendChild(meta);
          row.appendChild(bubble);
          el.appendChild(row);
        }
        if (wasAtBottom && el.lastElementChild) {
          el.lastElementChild.scrollIntoView({ block: "end" });
        }
      }

      function renderListings(el, listings) {
        el.innerHTML = "";
        if (!listings.length) {
          const empty = document.createElement("div");
          empty.className = "listing-empty";
          empty.textContent = "No listings yet.";
          el.appendChild(empty);
          return;
        }
        const latest = listings
          .filter((l) => l.type === "LISTING_CREATE" && l.data)
          .slice(-10)
          .reverse();
        for (const entry of latest) {
          const card = document.createElement("div");
          const listingType = String(entry.data.type || "").toLowerCase();
          card.className = `listing-card ${listingType === "buy" ? "buy" : listingType === "sell" ? "sell" : ""}`;
          const header = document.createElement("div");
          header.className = "listing-header";
          const label = listingType === "buy" ? "Want to Buy" : listingType === "sell" ? "Want to Sell" : "Listing";
          header.textContent = `${label} 路 ${entry.data.item}`;
          const badge = document.createElement("span");
          badge.className = `listing-badge ${listingType === "buy" ? "buy" : listingType === "sell" ? "sell" : ""}`;
          badge.textContent = listingType === "buy" ? "Buyer Intent" : listingType === "sell" ? "Seller Listing" : "Listing";
          const meta = document.createElement("div");
          meta.className = "listing-meta";
          meta.textContent = `${entry.data.price} ${entry.data.currency} 路 ${entry.data.condition || "condition?"} 路 ${entry.data.ship || "ship?"}`;
          const id = document.createElement("div");
          id.className = "listing-id";
          id.textContent = `id: ${entry.data.id}`;
          const who = document.createElement("div");
          who.className = "listing-who";
          who.textContent = `by ${entry.sender}`;
          card.appendChild(header);
          card.appendChild(badge);
          card.appendChild(meta);
          card.appendChild(id);
          card.appendChild(who);
          el.appendChild(card);
        }
      }


      function renderBoard(listEl, selectedEl, messages) {
        listEl.innerHTML = "";
        if (messages.length === 0) {
          selectedEl.textContent = "No gossip yet.";
          return;
        }

        let selectedIndex = Number(listEl.dataset.selectedIndex || "0");
        const autoFollow = listEl.dataset.autoFollow === "1";
        if (Number.isNaN(selectedIndex) || selectedIndex < 0) selectedIndex = 0;
        if (autoFollow || selectedIndex >= messages.length) {
          selectedIndex = messages.length - 1;
          listEl.dataset.selectedIndex = String(selectedIndex);
        }

        const selected = messages[selectedIndex];
        selectedEl.textContent = `${selected.sender}: ${selected.body}`;

        messages.forEach((msg, idx) => {
          const card = document.createElement("button");
          card.className = "offer";
          card.type = "button";
          card.dataset.index = String(idx);
          if (idx === selectedIndex) card.classList.add("active");

          const title = document.createElement("div");
          title.className = "offer-title";
          title.textContent = msg.sender;

          const body = document.createElement("div");
          body.className = "offer-body";
          body.textContent = msg.body;

          card.appendChild(title);
          card.appendChild(body);

          card.addEventListener("click", () => {
            listEl.dataset.selectedIndex = String(idx);
            listEl.dataset.autoFollow = "0";
            renderBoard(listEl, selectedEl, messages);
          });

          listEl.appendChild(card);
        });

        if (autoFollow && listEl.lastElementChild) {
          listEl.lastElementChild.scrollIntoView({ block: "end" });
        }
      }

      async function fetchLogs() {
        try {
          const selection = window.getSelection && window.getSelection();
          if (selection && selection.type === "Range") {
            statusEl.textContent = "Paused (text selected)";
            return;
          }
          const res = await fetch("/logs");
          const data = await res.json();
          const gossipMessages = parseLog(data.gossip || "").sort((a, b) => a.tsMs - b.tsMs || a.idx - b.idx);
          renderBoard(gossipEl, document.getElementById("gossipSelected"), gossipMessages);
          const dmMessages = parseLog(data.dm || "").sort((a, b) => a.tsMs - b.tsMs || a.idx - b.idx);
          renderChat(dmEl, dmMessages);
          statusEl.textContent = "Live";
        } catch (e) {
          statusEl.textContent = "Offline";
        }
      }

      async function fetchRoles() {
        try {
          const res = await fetch("/roles");
          const roles = await res.json();
          const buyer = roles.buyer || "unknown";
          const seller = roles.seller || "unknown";
          const llm = roles.llm || "unknown";
          const mode = roles.mode || "unknown";
          rolesEl.innerHTML = `
            <div class="role-card">
              <div class="role-label">Buyer</div>
              <div class="role-value">${buyer}</div>
            </div>
            <div class="role-card">
              <div class="role-label">Seller</div>
              <div class="role-value">${seller}</div>
            </div>
            <div class="role-card highlight">
              <div class="role-label">LLM Agent</div>
              <div class="role-value">${llm}</div>
              <div class="role-mode">${mode}</div>
            </div>
          `;
        } catch (e) {
          rolesEl.innerHTML = `
            <div class="role-card">
              <div class="role-label">Buyer</div>
              <div class="role-value">unknown</div>
            </div>
            <div class="role-card">
              <div class="role-label">Seller</div>
              <div class="role-value">unknown</div>
            </div>
            <div class="role-card highlight">
              <div class="role-label">LLM Agent</div>
              <div class="role-value">unknown</div>
            </div>
          `;
        }
      }

      async function fetchListings() {
        try {
          const res = await fetch("/listings");
          const data = await res.json();
          const listings = Array.isArray(data.listings) ? data.listings : [];
          renderListings(listingsEl, listings);
        } catch (e) {
          renderListings(listingsEl, []);
        }
      }


      function renderDeals(el, deals) {
        el.innerHTML = "";
        if (!deals.length) {
          const empty = document.createElement("div");
          empty.className = "deal-empty";
          empty.textContent = "No deal summaries yet.";
          el.appendChild(empty);
          return;
        }
        const latest = deals.slice(-10).reverse();
        for (const entry of latest) {
          const row = document.createElement("div");
          row.className = `deal-row ${entry.type === "DEAL_SUMMARY" ? "summary" : "confirmed"}`;
          const label = document.createElement("div");
          label.className = "deal-label";
          label.textContent = entry.type.replace("_", " ");
          const body = document.createElement("div");
          body.className = "deal-body";
          body.textContent = entry.text || entry.raw || "";
          const meta = document.createElement("div");
          meta.className = "deal-meta";
          meta.textContent = `${entry.sender}`;
          row.appendChild(label);
          row.appendChild(body);
          row.appendChild(meta);
          el.appendChild(row);
        }
      }

      async function fetchDeals() {
        try {
          const res = await fetch("/deals");
          const data = await res.json();
          const deals = Array.isArray(data.deals) ? data.deals : [];
          renderDeals(dealsEl, deals);
        } catch (e) {
          renderDeals(dealsEl, []);
        }
      }

      gossipEl.dataset.forceBottom = "1";
      dmEl.dataset.forceBottom = "1";
      fetchLogs();
      fetchRoles();
      fetchListings();
      fetchDeals();
      setInterval(fetchLogs, 1000);
      setInterval(fetchRoles, 5000);
      setInterval(fetchListings, 3000);
      setInterval(fetchDeals, 3000);

      document.getElementById("resetBtn").addEventListener("click", async () => {
        statusEl.textContent = "Resetting...";
        gossipEl.dataset.autoFollow = "1";
        dmEl.dataset.forceBottom = "1";
        gossipEl.dataset.selectedIndex = "0";
        gossipEl.innerHTML = "";
        document.getElementById("gossipSelected").textContent = "No gossip yet.";
        dmEl.innerHTML = "";
        try {
          const res = await fetch("/reset", { method: "POST" });
          if (!res.ok) throw new Error("Reset failed");
          statusEl.textContent = "Reset queued";
        } catch {
          statusEl.textContent = "Reset failed";
        }
      });
    </script>
  </body>
</html>
